name: Validate OpenAPI Specification

on:
  push:
    branches: [ main, master ]
    paths:
      - '[0-9]+\.[0-9]+\.[0-9]+/**'
      - 'common/**'
      - '.github/workflows/validate.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '[0-9]+\.[0-9]+\.[0-9]+/**'
      - 'common/**'
      - '.github/workflows/validate.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ['2.2.1', '2.3.0']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if version exists
        id: check_version
        run: |
          if [ -d "${{ matrix.version }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ matrix.version }} directory found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ matrix.version }} directory not found, skipping job..."
          fi
      
      - name: Setup Node.js
        if: steps.check_version.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install swagger-cli
        if: steps.check_version.outputs.exists == 'true'
        run: npm install -g swagger-cli
      
      - name: Install yamllint
        if: steps.check_version.outputs.exists == 'true'
        run: pip install yamllint
      
      - name: Validate common definitions
        if: steps.check_version.outputs.exists == 'true'
        run: |
          swagger-cli validate common/definitions.yaml || echo "Note: definitions.yaml is not a complete OpenAPI spec (expected)"
      
      - name: Validate component files (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Validating component files for ${{ matrix.version }}..."
          # These are partial OpenAPI files, so we'll check YAML syntax
          yamllint -c .yamllint ${{ matrix.version }}/components/parameters.yaml ${{ matrix.version }}/components/responses.yaml
      
      - name: Validate module files (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Validating module files for ${{ matrix.version }}..."
          # These are partial OpenAPI files, so we'll check YAML syntax
          for file in ${{ matrix.version }}/modules/*.yaml; do
            echo "Checking $file..."
            yamllint -c .yamllint "$file"
          done
      
      - name: Install Spectral
        if: steps.check_version.outputs.exists == 'true'
        run: npm install -g @stoplight/spectral-cli
      
      - name: Create symlink for common definitions (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Create symlink to allow individual file Spectral linting
          mkdir -p ${{ matrix.version }}/common
          ln -sf ../../common/definitions.yaml ${{ matrix.version }}/common/definitions.yaml
          echo "✓ Symlink created for ${{ matrix.version }}/common/definitions.yaml"
      
      - name: Lint component files with Spectral (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Linting component files with Spectral for ${{ matrix.version }}..."
          for file in ${{ matrix.version }}/components/*.yaml; do
            echo "Linting $(basename $file)..."
            spectral lint "$file"
          done
      
      - name: Lint module files with Spectral (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Linting module files with Spectral for ${{ matrix.version }}..."
          for file in ${{ matrix.version }}/modules/*.yaml; do
            echo "Linting $(basename $file)..."
            spectral lint "$file"
          done
      
      - name: Validate main OpenAPI specification (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Try to validate main spec (may fail for modular specs, which is OK)
          if swagger-cli validate ${{ matrix.version }}/ocpi-${{ matrix.version }}.yaml; then
            echo "✓ Main OpenAPI specification is valid"
          else
            echo "⚠ Main OpenAPI specification validation failed (may be expected for modular specs)"
            echo "Will validate bundled specification instead..."
          fi
      
      - name: Bundle specification (test all references) (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Check that all $ref references resolve by bundling
          swagger-cli bundle ${{ matrix.version }}/ocpi-${{ matrix.version }}.yaml -o /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ All references resolved successfully"
          echo "✓ Bundled specification created at /tmp/bundled-${{ matrix.version }}.yaml"
          
      - name: Validate bundled specification (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Validate the bundled spec to ensure it's still valid after bundling
          swagger-cli validate /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ Bundled specification is valid"
      
      - name: Lint bundled specification with Spectral (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Lint the complete, resolved bundled specification
          spectral lint /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ Bundled Spectral linting passed"