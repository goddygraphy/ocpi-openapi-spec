name: Validate OpenAPI Specification

on:
  push:
    branches: [ main, master ]
    paths:
      - '[0-9]+\.[0-9]+\.[0-9]+/**'
      - 'common/**'
      - '.github/workflows/validate.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '[0-9]+\.[0-9]+\.[0-9]+/**'
      - 'common/**'
      - '.github/workflows/validate.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ['2.2.1', '2.3.0']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if version exists
        id: check_version
        run: |
          if [ -d "${{ matrix.version }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ matrix.version }} directory found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ matrix.version }} directory not found, skipping job..."
          fi
      
      - name: Setup Node.js
        if: steps.check_version.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install swagger-cli
        if: steps.check_version.outputs.exists == 'true'
        run: npm install -g swagger-cli
      
      - name: Install yamllint
        if: steps.check_version.outputs.exists == 'true'
        run: pip install yamllint
      
      - name: Validate common definitions
        if: steps.check_version.outputs.exists == 'true'
        run: |
          swagger-cli validate common/definitions.yaml || echo "Note: definitions.yaml is not a complete OpenAPI spec (expected)"
      
      - name: Validate component files (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Validating component files for ${{ matrix.version }}..."
          # These are partial OpenAPI files, so we'll check YAML syntax
          yamllint -c .yamllint ${{ matrix.version }}/components/parameters.yaml ${{ matrix.version }}/components/responses.yaml
      
      - name: Validate module files (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "Validating module files for ${{ matrix.version }}..."
          # These are partial OpenAPI files, so we'll check YAML syntax
          for file in ${{ matrix.version }}/modules/*.yaml; do
            echo "Checking $file..."
            yamllint -c .yamllint "$file"
          done
      
      - name: Install Spectral
        if: steps.check_version.outputs.exists == 'true'
        run: npm install -g @stoplight/spectral-cli
      
      - name: Bundle specification (test all references) (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Check that all $ref references resolve by bundling
          swagger-cli bundle ${{ matrix.version }}/ocpi-${{ matrix.version }}.yaml -o /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ All references resolved successfully"
          echo "✓ Bundled specification created at /tmp/bundled-${{ matrix.version }}.yaml"
          
      - name: Validate bundled specification (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Validate the bundled spec to ensure it's still valid after bundling
          swagger-cli validate /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ Bundled specification is valid"
      
      - name: Lint bundled specification with Spectral (${{ matrix.version }})
        if: steps.check_version.outputs.exists == 'true'
        run: |
          # Lint the complete, resolved bundled specification
          spectral lint /tmp/bundled-${{ matrix.version }}.yaml
          echo "✓ Bundled Spectral linting passed"
      
      - name: Set validation result
        if: always()
        run: |
          if [ "${{ steps.check_version.outputs.exists }}" == "true" ]; then
            echo "✅ Version ${{ matrix.version }} was validated successfully"
          else
            echo "⏭️  Version ${{ matrix.version }} skipped (directory does not exist)"
          fi
  
  validate-all:
    name: Validate All Versions
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "Checking validation results for all versions..."
          echo ""
          # Check if any matrix job failed
          # With matrix strategies:
          # - If ANY job fails → needs.validate.result = 'failure'
          # - If ALL jobs succeed (including skipped) → needs.validate.result = 'success'
          # Skipped jobs (all steps skipped) report as 'success', which is what we want
          
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "❌ One or more validation jobs failed"
            echo "Please check the individual matrix job results above"
            exit 1
          fi
          
          echo "✅ All validations passed"
          echo "✅ Skipped versions (non-existent directories) are allowed"